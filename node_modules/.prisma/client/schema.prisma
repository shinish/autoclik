// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Automation {
  id          String   @id @default(uuid())
  name        String   @unique
  namespace   String
  description String?
  keywords    String? // JSON array as string
  tags        String? // JSON array as string
  formSchema  String // JSON schema for the input form
  apiEndpoint String?
  templateId  String
  inventoryId String?
  extraVars   String? // YAML mapping as string (deprecated)
  customBody  String? // JSON template for complete request body with variables like {{form.fieldname}}
  pinned      Boolean  @default(false)
  featured    Boolean  @default(false)
  runs        Int      @default(0)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  runs_history Run[]
  schedules    Schedule[]
}

model Run {
  id           String     @id @default(uuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  status       String // success, failed, running, pending
  uniqueId     String?    @unique // Unique run identifier (e.g., TASK25A00000001i)
  parameters   String? // JSON string of input parameters
  result       String? // JSON string of result
  artifacts    String? // JSON string of artifacts from AWX job
  errorMessage String?
  executedBy   String? // User who executed the run (email or username)
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
  awxJobId     String? // AWX job ID for tracking

  @@index([automationId])
  @@index([uniqueId])
}

model Schedule {
  id           String     @id @default(uuid())
  name         String
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  frequency    String // e.g., "daily", "weekly", "monthly"
  cron         String // Cron expression
  parameters   String? // JSON string of default parameters
  status       String     @default("active") // active, paused
  nextRun      DateTime?
  lastRun      DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([automationId])
}

model Notification {
  id        String   @id @default(uuid())
  type      String // error, warning, info, success
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ConnectivityCheck {
  id          String    @id @default(uuid())
  servers     String // JSON array of server objects
  ports       String // Comma-separated ports
  email       String
  status      String    @default("pending") // pending, running, completed, failed
  results     String? // JSON string of results
  createdAt   DateTime  @default(now())
  completedAt DateTime?
}

model Namespace {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  description String?
  color       String   @default("#546aff")
  icon        String?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions NamespacePermission[]
}

model User {
  id             String   @id @default(uuid())
  firstName      String
  lastName       String
  name           String // Full name (computed or stored)
  samAccountName String?  @unique // Active Directory username
  email          String   @unique
  password       String   @default("") // Hashed password
  role           String   @default("user") // admin, user
  enabled        Boolean  @default(true)
  locked         Boolean  @default(false)
  location       String?
  department     String? // Department/Team
  profilePhoto   String? // Base64 encoded low-quality profile photo
  managerId      String?
  manager        User?    @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates   User[]   @relation("ManagerSubordinates")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  groupMemberships GroupMember[]
  permissions      NamespacePermission[]
}

model Group {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String?
  isPredefined Boolean  @default(false) // For system predefined groups
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members           GroupMember[]
  permissions       NamespacePermission[]
  modulePermissions ModulePermission[]
}

model GroupMember {
  id        String   @id @default(uuid())
  userId    String
  groupId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

model NamespacePermission {
  id          String    @id @default(uuid())
  namespaceId String
  namespace   Namespace @relation(fields: [namespaceId], references: [id], onDelete: Cascade)

  // Either userId or groupId should be set
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  groupId String?
  group   Group?  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Permissions: read, write, execute, admin
  canRead    Boolean @default(true)
  canWrite   Boolean @default(false)
  canExecute Boolean @default(false)
  canAdmin   Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([namespaceId])
  @@index([userId])
  @@index([groupId])
}

model ModulePermission {
  id      String @id @default(uuid())
  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Module name: dashboard, automations, schedules, catalog, settings
  module String

  // Permissions for this module
  canRead   Boolean @default(true)
  canWrite  Boolean @default(false)
  canDelete Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([groupId, module])
  @@index([groupId])
}

model Credential {
  id             String  @id @default(uuid())
  name           String  @unique
  description    String?
  credentialType String // machine, vault, network, cloud, etc.

  // Credential fields (stored as encrypted JSON)
  username      String?
  password      String? // Encrypted
  sshPrivateKey String? // Encrypted
  vaultPassword String? // Encrypted - for Ansible Vault

  // Additional metadata
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Setting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Activity {
  id          String   @id @default(uuid())
  action      String // created, updated, deleted, executed
  entityType  String // automation, schedule, namespace, user, etc.
  entityId    String
  entityName  String
  description String?
  performedBy String // Username or user ID
  metadata    String? // JSON string of additional data
  createdAt   DateTime @default(now())

  @@index([entityType])
  @@index([createdAt])
}

model RunCounter {
  id       String   @id @default(uuid())
  year     Int // Year (e.g., 2025)
  pool     String // Pool identifier (A-E)
  sequence Int      @default(0) // Sequential counter
  lastUsed DateTime @default(now())

  @@unique([year, pool])
  @@index([year])
}
