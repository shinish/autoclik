---
- name: Server Connectivity Check
  hosts: localhost
  gather_facts: no
  vars:
    check_hosts: "{{ check_hosts | default(['google.com', 'github.com', '8.8.8.8']) }}"
    timeout: "{{ timeout | default(5) }}"
  tasks:
    - name: Initialize results dictionary
      set_fact:
        connectivity_results: {}

    - name: Check connectivity to each host (HTTP/HTTPS)
      uri:
        url: "https://{{ item }}"
        method: GET
        timeout: "{{ timeout }}"
        validate_certs: no
        status_code: 200,201,202,203,204,205,206,300,301,302,303,304,307,308,400,401,403,404,405,500,502,503
      register: http_results
      loop: "{{ check_hosts }}"
      ignore_errors: yes
      changed_when: false

    - name: Build results dictionary
      set_fact:
        connectivity_results: "{{ connectivity_results | combine({item.item: ('Success' if item.status is defined and item.status > 0 else 'Failed')}) }}"
      loop: "{{ http_results.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Display connectivity results
      debug:
        msg: "{{ connectivity_results }}"

    - name: Save results as artifact
      set_stats:
        data:
          connectivity_check: "{{ connectivity_results }}"
        per_host: no
