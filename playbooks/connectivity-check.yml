---
- name: Server Connectivity Check
  hosts: localhost
  gather_facts: no
  vars:
    check_hosts:
      - google.com
      - github.com
      - invalid.xyz.test
  tasks:
    - name: Initialize results dictionary
      set_fact:
        connectivity_results: {}

    - name: Check connectivity to each host (HTTP/HTTPS)
      uri:
        url: "https://{{ item }}"
        method: GET
        timeout: 5
        validate_certs: no
        status_code: -1
      register: http_results
      loop: "{{ check_hosts }}"
      ignore_errors: yes
      changed_when: false

    - name: Build results dictionary
      set_fact:
        connectivity_results: "{{ connectivity_results | combine({item.item: ('Success' if item.status is defined and item.status > 0 else 'Failed')}) }}"
      loop: "{{ http_results.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Display connectivity results
      debug:
        msg: "{{ connectivity_results }}"

    - name: Save results as artifact
      set_stats:
        data:
          connectivity_check: "{{ connectivity_results }}"
        per_host: no
