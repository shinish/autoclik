services:
  # PostgreSQL Database for AWX
  postgres:
    image: postgres:13
    container_name: awx-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: awx
      POSTGRES_USER: awx
      POSTGRES_PASSWORD: awxpass
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - awx-postgres-data:/var/lib/postgresql/data
    networks:
      - awx-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U awx"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for AWX
  redis:
    image: redis:7
    container_name: awx-redis
    restart: unless-stopped
    networks:
      - awx-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # AWX Web Server (using older community maintained version)
  awx-web:
    image: ansible/awx:17.1.0
    container_name: awx-web
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    hostname: awx
    user: root
    ports:
      - "8080:80"
    volumes:
      - awx-projects:/var/lib/awx/projects
      - ./awx-settings/credentials.py:/etc/tower/conf.d/credentials.py:ro
      - ./awx-settings/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - awx-network

  # AWX Task Runner
  awx-task:
    image: ansible/awx:17.1.0
    container_name: awx-task
    restart: unless-stopped
    depends_on:
      - awx-web
    hostname: awx-task
    user: root
    volumes:
      - awx-projects:/var/lib/awx/projects
      - ./awx-settings/credentials.py:/etc/tower/conf.d/credentials.py:ro
    networks:
      - awx-network
    command: launch_awx_task.sh

networks:
  awx-network:
    driver: bridge

volumes:
  awx-postgres-data:
  awx-projects:
